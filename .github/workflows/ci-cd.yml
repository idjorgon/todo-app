name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run unit tests
        working-directory: ./backend
        run: mvn clean test

      - name: Run integration tests
        working-directory: ./backend
        run: mvn verify

      - name: Generate test coverage report
        working-directory: ./backend
        run: mvn jacoco:report

      - name: Upload backend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            backend/target/surefire-reports/**/*.xml
            backend/target/site/jacoco/**/*
          retention-days: 30

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run linter
        working-directory: ./frontend
        run: npx eslint "src/**/*.{ts,tsx}" || true

      - name: Run unit tests
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false

      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/coverage/**/*
          retention-days: 30

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [backend-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Start backend
        working-directory: ./backend
        run: |
          mvn clean install -DskipTests
          mvn spring-boot:run &
          sleep 30

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps

      - name: Run E2E tests
        working-directory: ./frontend
        run: npm run test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

  attest-test-results:
    name: Attest Test Results
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, e2e-test]
    if: always()
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: Download backend test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-test-results
          path: test-results/backend

      - name: Download frontend test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frontend-test-results
          path: test-results/frontend

      - name: Download e2e test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: playwright-report
          path: test-results/e2e

      - name: Create test results summary
        run: |
          mkdir -p test-results-summary
          echo "Test Results Summary" > test-results-summary/summary.txt
          echo "===================" >> test-results-summary/summary.txt
          echo "" >> test-results-summary/summary.txt
          echo "Workflow Run: ${{ github.run_id }}" >> test-results-summary/summary.txt
          echo "Commit SHA: ${{ github.sha }}" >> test-results-summary/summary.txt
          echo "Branch: ${{ github.ref_name }}" >> test-results-summary/summary.txt
          echo "Actor: ${{ github.actor }}" >> test-results-summary/summary.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-results-summary/summary.txt
          echo "" >> test-results-summary/summary.txt
          echo "Job Results:" >> test-results-summary/summary.txt
          echo "- Backend Tests: ${{ needs.backend-test.result }}" >> test-results-summary/summary.txt
          echo "- Frontend Tests: ${{ needs.frontend-test.result }}" >> test-results-summary/summary.txt
          echo "- E2E Tests: ${{ needs.e2e-test.result }}" >> test-results-summary/summary.txt
          
          # Copy all test artifacts to summary directory
          if [ -d "test-results" ]; then
            cp -r test-results/* test-results-summary/ 2>/dev/null || true
          fi

      - name: Upload consolidated test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-summary
          path: test-results-summary/
          retention-days: 90

      - name: Attest test results
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'test-results-summary/'

  build-backend:
    name: Build Backend Artifact
    runs-on: ubuntu-latest
    needs: [backend-test]
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build backend
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        id: backend-artifact
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 30

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'backend/target/*.jar'

  build-frontend:
    name: Build Frontend Artifact
    runs-on: ubuntu-latest
    needs: [frontend-test]
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        id: frontend-artifact
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 30

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'frontend/build/'